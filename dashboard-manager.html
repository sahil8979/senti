<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbon Sentinel - Process Manager Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar hiding */
        .overflow-y-auto-hidden-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .overflow-y-auto-hidden-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 overflow-hidden">

    <!-- ASSUMED LOGGED-IN USER: John Doe, Manager ID 1 -->
    <script>
        const CURRENT_MANAGER_ID = 1; // Corresponds to John Doe (Process Manager)
        
        // --- Shared Data Loading and Polling Logic ---
        
        let managerBatches = []; // Local state for batches assigned to CURRENT_MANAGER_ID

        /**
         * Reads the shared batch data from localStorage and filters it for the current manager.
         * Rerenders the relevant parts of the dashboard if new assignments are found.
         */
        function loadAndUpdateBatches() {
            const storedBatches = localStorage.getItem('activeBatchesDetailed');
            let allBatches = [];
            if (storedBatches) {
                allBatches = JSON.parse(storedBatches);
            }

            // 1. Filter batches assigned to the current manager
            const filteredBatches = allBatches.filter(batch => batch.managerId === CURRENT_MANAGER_ID);

            // 2. Check if the list has changed since last render
            // Using JSON.stringify for a deep comparison since these are arrays of objects
            if (filteredBatches.length !== managerBatches.length || 
                JSON.stringify(filteredBatches) !== JSON.stringify(managerBatches)) {
                
                managerBatches = filteredBatches;
                renderDashboardContent();
            }
        }

        /**
         * Renders the dynamic batch list and updates key metrics.
         */
        function renderDashboardContent() {
            const upcomingContainer = document.getElementById('upcoming-batches-container');
            const activeBatchesMetric = document.getElementById('metric-active-batches');
            const upcomingBatchesMetric = document.getElementById('metric-upcoming-batches');
            
            // Separate batches into Upcoming (Status: Data Entry Pending) and Active/Completed
            const upcomingBatches = managerBatches.filter(b => b.status === 'Data Entry Pending');
            const liveBatches = managerBatches.filter(b => b.status !== 'Data Entry Pending');
            
            // --- Update Key Metrics ---
            upcomingBatchesMetric.textContent = upcomingBatches.length;
            // Note: We include the mock static 5 active batches for the metric display
            activeBatchesMetric.textContent = liveBatches.length + 5; 

            // --- Render Upcoming Batches Section ---
            upcomingContainer.innerHTML = '';
            
            if (upcomingBatches.length === 0) {
                upcomingContainer.innerHTML = `
                    <div class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-8 text-center text-gray-500">
                        <p class="font-bold text-lg">Queue Clear</p>
                        <p class="text-sm mt-1">No new batch assignments currently awaiting workflow definition.</p>
                    </div>
                `;
            } else {
                upcomingBatches.forEach(batch => {
                    const batchCard = document.createElement('div');
                    batchCard.className = 'bg-white border rounded-xl shadow-md p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center transition duration-150 hover:shadow-lg';
                    batchCard.innerHTML = `
                        <div>
                            <p class="font-bold text-lg text-gray-900">Batch ID: ${batch.batchId}</p>
                            <p class="text-sm text-gray-600">Product: ${batch.product}</p>
                            <p class="text-xs text-gray-500 mt-1">Assigned on: ${batch.creationDate}</p>
                        </div>
                        <a href="phase-workflow-builder.html?batch=${batch.batchId}" class="mt-3 sm:mt-0 bg-emerald-600 text-white font-semibold py-2 px-4 rounded-xl shadow-md hover:bg-emerald-700 transition duration-150">Build Workflow</a>
                    `;
                    upcomingContainer.appendChild(batchCard);
                });
            }
        }

        // --- Polling Setup ---
        // Poll every 2 seconds to check for new batches assigned by the Top Manager
        document.addEventListener('DOMContentLoaded', () => {
            loadAndUpdateBatches(); // Initial load
            // Set up polling to fetch data every 2 seconds
            setInterval(loadAndUpdateBatches, 2000); 
        });
        
    </script>
    

    <div class="flex h-screen">
        <!-- Sidebar Navigation (Static) -->
        <aside id="sidebar" class="bg-white shadow-lg w-64 flex flex-col hidden lg:flex">
            <div class="p-6 flex items-center space-x-4 border-b">
                <svg class="h-8 w-8 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg>
                <span id="logo-text" class="font-bold text-xl">Carbon Sentinel</span>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                 <a href="dashboard-manager.html" class="flex items-center p-3 rounded-xl text-gray-800 bg-emerald-100 font-semibold shadow-inner text-sm">
                    <svg class="h-6 w-6 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
                    <span class="ml-4">Dashboard</span>
                </a>
                <a href="#" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>
                    <span class="ml-4">My Tasks</span>
                </a>
                <a href="#" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 9.75v3.75m0 0l-3.75 2.25M12.75 13.5l3.75 2.25" /></svg>
                    <span class="ml-4">Strategic Analysis</span>
                </a>
            </nav>
            <div class="px-4 py-6 border-t mt-auto">
                <a href="login.html" class="flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-200">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
                    <span class="ml-4">Logout</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 lg:p-8 overflow-y-auto overflow-y-auto-hidden-scrollbar bg-white">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div class="flex justify-between items-center pb-6 border-b">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Process Manager Dashboard</h1>
                        <p class="text-gray-500 mt-1">Welcome back, John Doe. (ID: ${CURRENT_MANAGER_ID})</p>
                    </div>
                     <div class="flex items-center space-x-4 mt-4 sm:mt-0 p-3 bg-gray-100 rounded-xl">
                        <img class="inline-block h-10 w-10 rounded-full ring-2 ring-white object-cover" src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="User Avatar">
                        <div>
                            <p class="font-semibold text-sm">John Doe</p>
                            <p class="text-xs text-gray-500">Process Manager</p>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-8">
                    <!-- Metric 1: Upcoming Batches (Dynamic) -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 transform hover:shadow-xl transition duration-300">
                        <h3 class="text-sm font-medium text-gray-500 uppercase">Upcoming Batches</h3>
                        <p id="metric-upcoming-batches" class="text-4xl font-extrabold text-emerald-600 mt-2">0</p>
                        <p class="text-xs text-gray-400 mt-1">Awaiting workflow definition</p>
                    </div>
                    <!-- Metric 2: Active Batches (Dynamic) -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 transform hover:shadow-xl transition duration-300">
                        <h3 class="text-sm font-medium text-gray-500 uppercase">Live Batches (Est.)</h3>
                        <p id="metric-active-batches" class="text-4xl font-extrabold text-blue-600 mt-2">0</p>
                        <p class="text-xs text-gray-400 mt-1">Currently in production</p>
                    </div>
                    <!-- Metric 3: Static Alerts -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 transform hover:shadow-xl transition duration-300">
                        <h3 class="text-sm font-medium text-gray-500 uppercase">Data Quality Alerts</h3>
                        <p class="text-4xl font-extrabold text-red-600 mt-2">1</p>
                        <p class="text-xs text-gray-400 mt-1">Requires immediate attention</p>
                    </div>
                    <!-- Metric 4: Static Liability -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 transform hover:shadow-xl transition duration-300">
                        <h3 class="text-sm font-medium text-gray-500 uppercase">Est. CBAM Liability</h3>
                        <p class="text-4xl font-extrabold text-gray-900 mt-2">â‚¬4.2M</p>
                        <p class="text-xs text-gray-400 mt-1">Projected for your phases</p>
                    </div>
                </div>

                <div class="mt-10 grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Main Content: Batches (Dynamic & Static) -->
                    <div class="lg:col-span-2 space-y-10">
                        
                        <!-- Upcoming Batch Assignments (DYNAMIC CONTENT) -->
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Upcoming Batch Assignments</h2>
                            <div id="upcoming-batches-container" class="space-y-4">
                                <!-- Dynamic content injected here via JavaScript polling -->
                                <div class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-8 text-center text-gray-500">
                                    <p class="font-bold text-lg">Queue Clear</p>
                                    <p class="text-sm mt-1">No new batch assignments currently awaiting workflow definition.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Live Batch Tracking (STATIC MOCK DATA) -->
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Live Batch Tracking (Mock Data)</h2>
                            <div class="space-y-4">
                                <!-- Batch Card 1 -->
                                <div class="bg-white border rounded-xl shadow-md p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-lg">Batch ID: HRC-2025-09-002</p>
                                            <p class="text-sm text-gray-600">Product: Hot-Rolled Coil (Active)</p>
                                        </div>
                                        <a href="batch-monitoring.html" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-xl hover:bg-blue-700 transition duration-150">View Live Status</a>
                                    </div>
                                    <div class="mt-4">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-sm font-medium text-gray-700">Data Collection Progress</span>
                                            <span class="text-sm font-medium text-gray-700">75%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                                            <div class="bg-blue-500 h-2.5 rounded-full" style="width: 75%"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Batch Card 2 -->
                                <div class="bg-white border rounded-xl shadow-md p-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-lg">Batch ID: HRC-2025-09-001</p>
                                            <p class="text-sm text-gray-600">Product: Hot-Rolled Coil (Completed)</p>
                                        </div>
                                        <a href="batch-report.html" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-xl hover:bg-gray-300 transition duration-150">View Report</a>
                                    </div>
                                    <div class="mt-4">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-sm font-medium text-gray-700">Data Collection Progress</span>
                                            <span class="text-sm font-medium text-gray-700">100% (Completed)</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                                            <div class="bg-emerald-500 h-2.5 rounded-full" style="width: 100%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar: Compliance & Risk Center (Static) -->
                    <div class="lg:col-span-1">
                         <div class="bg-white border rounded-xl p-6 sticky top-8 shadow-lg">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Compliance & Risk Center</h2>
                            <div class="space-y-6">
                                <!-- Alert Item -->
                                <div>
                                    <h3 class="font-semibold text-gray-700 mb-2">Data Quality Alerts</h3>
                                    <div class="bg-white p-4 rounded-xl shadow-md border border-red-300">
                                        <p class="text-sm font-semibold text-red-600">Batch ID: HRC-2025-09-002</p>
                                        <h4 class="font-bold mt-1">Inconsistent Gas Meter Reading</h4>
                                        <p class="text-xs text-gray-500 mt-2">From: Audit Team</p>
                                        <p class="text-sm text-gray-600 mt-2">"The sensor data for BF-GAS-001 shows a 15% deviation..."</p>
                                        <button class="mt-4 w-full bg-red-600 text-white font-semibold py-2 rounded-xl hover:bg-red-700 transition duration-150">View Details</button>
                                    </div>
                                </div>
                                <!-- Hotspot Item -->
                                <div>
                                    <h3 class="font-semibold text-gray-700 mb-2">Process Emissions Hotspots</h3>
                                    <div class="bg-white p-4 rounded-xl shadow-md border">
                                        <ul class="space-y-3 text-sm">
                                            <li class="flex justify-between"><span>1. Blast Furnace</span><span class="font-bold">65%</span></li>
                                            <li class="flex justify-between"><span>2. Sinter Plant</span><span class="font-bold">18%</span></li>
                                            <li class="flex justify-between"><span>3. Coke Oven</span><span class="font-bold">12%</span></li>
                                            <li class="flex justify-between text-gray-500"><span>4. Others</span><span>5%</span></li>
                                        </ul>
                                        <button class="mt-4 w-full bg-gray-200 text-gray-800 font-semibold py-2 rounded-xl hover:bg-gray-300 transition duration-150">Analyze Further</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

</body>
</html>
